<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
<!--         <script type="text/javascript" src="../d3.v3.js"></script> -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <style type="text/css">
            .axis path,
            .axis line {
                fill: none;
                stroke: black;
                shape-rendering: crispEdges;
            }

            .axis text {
                font-family: sans-serif;
                font-size: 11px;
            }

            ul {
                padding: 10px;
                margin:25px;
                list-style-type: none;
            }

            li {
                margin: 2px;
                padding: 5px;
                border: 5px;
                border-radius: 5px;
                display: inline-block; 
                background: #bbb;
            }
        </style>
    </head>
    <body>
        <div id="barDiv">
            <p>Click on this text to update the chart with new data values (once).</p>
        </div>

        <div id="histDiv">
            <ul id="utcMetric"> 
                <li class = "layer" id = "Can_P"> Percent Canopy </li>
                <li class = "layer" id = "Imperv_P"> Percent Impervious </li>
                <li class = "layer" id = "Grass_P"> Percent Grass </li>
            </ul>

        <script type="text/javascript">
            // D3 code goes here - all based on examples from Scott Murray's Interactive Data Visualization for Web   http://chimera.labs.oreilly.com/books/1230000000345

            //set variables for the SVG element
            var w = 3600;
            var h = 300;

            var wS = 800;

            var wH = 900;

            var padding = 30;

            //create the SVG element appended to the body of the page
            var svgBar = d3.select("#barDiv")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

            var svgHist = d3.select("#histDiv")
                .append("svg")
                .attr("width", wH)
                .attr("height", h);

            var barPadding = 2;

            var dataset, dataset2;

            var layerID, dataID;  //var for saving button click IDs

            var dataHist; //var for storing histogram values

            //CALL THE LandCover Summary DATA
            d3.json("landcoversumm.geojson", function(data) {
                dataset = data;
                //window.dataset = dataset;
                //console.log(dataset);

                //code for creating the bar graph
                var dImperv_P = dataset.features.map(function (d) {
                    return d.properties.Imperv_P
                });
                window.dImperv_P = dImperv_P;
                // console.log(dImperv_P);

                var dGrass_P = dataset.features.map(function (d) {
                    return d.properties.Grass_P
                });

                var dCan_P = dataset.features.map(function (d) {
                    return d.properties.Can_P
                });

                var xScale = d3.scale.ordinal()
                    .domain(d3.range(dImperv_P.length))
                    .rangeRoundBands([0, w], 0.05);

                var yScale = d3.scale.linear()
                    .domain([0, d3.max(dImperv_P)])
                    .range([0, h]);

                //create the bars
                svgBar.selectAll("rect")
                    .data(dImperv_P)
                    .enter()
                    .append("rect")
                    .attr("x", function(d, i) {
                        return xScale(i);
                    })
                    .attr("y", function(d) {
                        return h - yScale(d);
                    })
                    .attr("width", xScale.rangeBand())
                    .attr("height", function(d) {
                        return yScale(d);
                    })
                    .attr("fill", function(d) {
                        return "rgb(0, 0, " + d3.round(d) + ")";
                    });
                    
                //create text labels
                svgBar.selectAll("text")
                    .data(dImperv_P)
                    .enter()
                    .append("text")
                    .text(function(d) {
                        return d3.round(d);
                        })
                    .attr("x", function(d, i) {
                        return xScale(i) + (w / dImperv_P.length - barPadding) / 2;
                        })
                    .attr("y", function(d) {
                        return h - yScale(d) + 14;              // +14
                    })
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");

                d3.select("p")
                    .on("click", function() {

                    //New values for dataset
                    var dCan_P = dataset.features.map(function (d) {
                            return d.properties.Can_P
                        });

                    //Update all rects
                    svgBar.selectAll("rect")
                        .data(dCan_P)
                        .transition()
                        .duration(1000)
                        .attr("y", function(d) {
                            return h - yScale(d);
                        })
                        .attr("height", function(d) {
                            return yScale(d);
                        })
                        .attr("fill", function(d) {   // <-- Down here!
                            return "rgb(0, 0, " + (d * 10) + ")";
                        });
                    

                    svgBar.selectAll("text")
                        .data(dCan_P)
                        .transition()
                        .duration(3000)
                        .text(function(d) {
                            return d3.round(d);
                        })
                        .attr("y", function(d) {
                            return h - yScale(d) + 14;              // +14
                        })
                        .attr("x", function(d, i) {
                            return xScale(i) + xScale.rangeBand() / 2;
                        })
                    });

                //code for creating histogram
                var xScaleHist = d3.scale.linear()
                    .domain([0,100])
                    .range([padding, wH - padding]);

                var dImpervHist = d3.layout.histogram()
                    .bins(xScaleHist.ticks(10))
                    (dImperv_P);

                var yScaleHist = d3.scale.linear()
                    .domain([0, d3.max(dImpervHist, function(d) { return d.length; })])
                    .range([h - padding, padding])
                    .nice();

                window.dImpervHist = dImpervHist;

                //create the bars
                svgHist.selectAll("rect")
                    .data(dImpervHist)
                    .enter()
                    .append("rect")
                    // .attr("x", function(d, i) {
                    //     return xScaleHist(i);
                    // })
                    .attr("x", function(d) { return xScaleHist(d.x)})
                    .attr("y", function(d) {
                        return yScaleHist(d.length);
                    })
                    .attr("width", xScaleHist(dImpervHist[0].dx)/2)
                    //.attr("width", xScaleHist(wS / dImpervHist.length))
                    //.attr("width", dImpervHist[0].dx)
                    .attr("height", function(d) {
                        return (h - padding) - yScaleHist(d.length);
                    })
                    .attr("fill", function(d) {
                        return "rgb(0, 0, " + d3.round(d.y) + ")";
                    });

                //create text labels
                svgHist.selectAll("text")
                    .data(dImpervHist)
                    .enter()
                    .append("text")
                    .text(function(d) {
                        return d3.round(d.length);
                        })
                    .attr("x", function(d) {
                        return xScaleHist(d.x) + xScaleHist(dImpervHist[0].dx)/4 ;
                        })
                    .attr("y", function(d) {
                        return yScaleHist(d.length) -10;              
                        })
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "11px")
                    .attr("fill", "#4682B4")
                    .attr("text-anchor", "middle");

                var yAxis = d3.svg.axis()
                    .scale(yScaleHist)
                    .orient("left")

                var yAxis2 = svgHist.append("g")
                        .attr("class", "y axis")
                        .attr("transform", "translate(" + padding + ",0)")
                        .call(yAxis);


                // d3.select("#Can_P")
                //     .on("click", function() {
                //     console.log(this);

                //     //New values for dataset
                //     var dCan_P = dataset.features.map(function (d) {
                //             return d.properties.Can_P
                //         });

                //     // var dCanHist = d3.layout.histogram()
                //     //     .bins(xScaleHist.ticks(10))
                //     //     (dCan_P);

                //     var dCanHist = d3.layout.histogram()
                //         .bins(xScaleHist.ticks(10))
                //         (dataset.features.map(function (d) {
                //             return d.properties.Can_P
                //         }));

                //     var yScaleHist = d3.scale.linear()
                //         .domain([0, d3.max(dCanHist, function(d) { return d.length; })])
                //         .range([h - padding, padding])
                //         .nice();

                //     //Update all rects
                //     svgHist.selectAll("rect")
                //         .data(dCanHist)
                //         .transition()
                //         .duration(1000)
                //         .attr("y", function(d) {
                //             return yScaleHist(d.length);
                //         })
                //         .attr("height", function(d) {
                //             return (h - padding) - yScaleHist(d.length);
                //         })
                //         .attr("fill", function(d) {
                //             return "rgb(0, 0, " + d3.round(d.y) + ")";
                //         });

                //     svgHist.selectAll("text")
                //         .data(dCanHist)
                //         .transition()
                //         .duration(3000)
                //         .text(function(d) {
                //             return d3.round(d.length);
                //         })
                //         .attr("y", function(d) {
                //             return yScaleHist(d.length) -10;              
                //         });

                //     yAxis.scale(yScaleHist);

                //     yAxis2.transition()
                //         .duration(3000)
                //         .call(yAxis);
                // })

                
                // d3.select("#Imperv_P")
                //     .on("click", function() {
                //     console.log(this);

                //     //New values for dataset
                //     // var dCan_P = dataset.features.map(function (d) {
                //     //         return d.properties.Imperv_P
                //     //     });

                //     // var dCanHist = d3.layout.histogram()
                //     //     .bins(xScaleHist.ticks(10))
                //     //     (dCan_P);

                //     var yScaleHist = d3.scale.linear()
                //         .domain([0, d3.max(dImpervHist, function(d) { return d.length; })])
                //         .range([h - padding, padding])
                //         .nice();

                //     //Update all rects
                //     svgHist.selectAll("rect")
                //         .data(dImpervHist)
                //         .transition()
                //         .duration(1000)
                //         .attr("y", function(d) {
                //             return yScaleHist(d.length);
                //         })
                //         .attr("height", function(d) {
                //             return (h - padding) - yScaleHist(d.length);
                //         })
                //         .attr("fill", function(d) {
                //             return "rgb(0, 0, " + d3.round(d.y) + ")";
                //         });

                //     svgHist.selectAll("text")
                //         .data(dImpervHist)
                //         .transition()
                //         .duration(3000)
                //         .text(function(d) {
                //             return d3.round(d.length);
                //         })
                //         .attr("y", function(d) {
                //             return yScaleHist(d.length) -10;              
                //         });

                //     yAxis.scale(yScaleHist);

                //     yAxis2.call(yAxis);
                // })

                //listeners for layer li clicks
                $(".layer").on("click", function() {
                    console.log(this)

                    layerID = $(this).attr("id");
                    window.layerID = layerID;

                // d3.select(".layer")
                //     .on("click", function() {
                //     console.log(this);

                    //New values for dataset
                    // var dCan_P = dataset.features.map(function (d) {
                    //         return d.properties.Imperv_P
                    //     });

                    // thisDataSet = dataset.features.map(function (d) {
                    //         return ('d.properties.'.concat(layerID)).valueOf()
                    //     });

                    switch(layerID){
                        case "Grass_P":
                            thisDataSet = dGrass_P;
                            break;
                        case "Imperv_P":
                            thisDataSet = dImperv_P;
                            break;
                        case "Can_P":
                            thisDataSet = dCan_P;
                            break;
                    }

                    // if (layerID == "Grass_P") thisDataSet = dGrass_P;
                    window.thisDataSet = thisDataSet;

                    // dataHist = d3.layout.histogram()
                    //     .bins(xScaleHist.ticks(10))
                    //     (dataset.features.map(function (d) {
                    //         return ("d.properties."+layerID).valueOf()
                    //     }));

                    dataHist = d3.layout.histogram()
                        .bins(xScaleHist.ticks(10))
                        (thisDataSet);

                    window.dataHist = dataHist;

                    var yScaleHist = d3.scale.linear()
                        .domain([0, d3.max(dataHist, function(d) { return d.length; })])
                        .range([h - padding, padding])
                        .nice();

                    //Update all rects
                    svgHist.selectAll("rect")
                        .data(dataHist)
                        .transition()
                        .duration(1000)
                        .attr("y", function(d) {
                            return yScaleHist(d.length);
                        })
                        .attr("height", function(d) {
                            return (h - padding) - yScaleHist(d.length);
                        })
                        .attr("fill", function(d) {
                            return "rgb(0, 0, " + d3.round(d.y) + ")";
                        });

                    svgHist.selectAll("text")
                        .data(dataHist)
                        .transition()
                        .duration(3000)
                        .text(function(d) {
                            return d3.round(d.length);
                        })
                        .attr("y", function(d) {
                            return yScaleHist(d.length) -10;              
                        });

                    yAxis.scale(yScaleHist);

                    yAxis2.call(yAxis);
                // })
                })

            });



            // //start circle dataset
            // var dScatter = [
            //       [ 5,     20 ],
            //       [ 480,   90 ],
            //       [ 250,   50 ],
            //       [ 100,   33 ],
            //       [ 330,   95 ],
            //       [ 410,   12 ],
            //       [ 475,   44 ],
            //       [ 25,    67 ],
            //       [ 85,    21 ],
            //       [ 220,   88 ]
            //   ];

            // //Dynamic, random dataset
            // var dRandom = [];
            // var numDataPoints = 50;
            // var xRange = Math.random() * 1000;
            // var yRange = Math.random() * 1000;
            // for (var i = 0; i < numDataPoints; i++) {
            //     var newNumber1 = Math.floor(Math.random() * xRange);
            //     var newNumber2 = Math.floor(Math.random() * yRange);
            //     dRandom.push([newNumber1, newNumber2]);
            // }

            // //Create SVG element
            // var svgScatter = d3.select("body")
            //     .append("svg")
            //     .attr("width", wS)
            //     .attr("height", h);

            // var xScale = d3.scale.linear()
            //     .domain([0, d3.max(dRandom, function(d) { return d[0]; })])
            //     .range([padding, wS - padding*2])
            //     .nice();

            // var yScale = d3.scale.linear()
            //     .domain([0, d3.max(dRandom, function(d) { return d[1]; })])
            //     .range([h - padding, padding]);

            // var xAxis = d3.svg.axis()
            //     .scale(xScale)
            //     .orient("bottom");

            // var yAxis = d3.svg.axis()
            //     .scale(yScale)
            //     .orient("left")
            //     .ticks(5);

            // svgScatter.selectAll("circle")  // <-- No longer "rect"
            //     .data(dRandom)
            //     .enter()
            //     .append("circle")  
            //     .attr("cx", function(d) {
            //         return xScale(d[0]);
            //     })
            //     .attr("cy", function(d) {
            //         return yScale(d[1]);
            //     })
            //     .attr("r", 5)
            //     .attr("r", function(d) {
            //         return Math.sqrt(h - d[1]);
            //     });

            // svgScatter.selectAll("text")
            //     .data(dRandom)
            //     .enter()
            //     .append("text")
            //     .text(function(d) {
            //         return d[0] + "," + d[1];
            //     })
            //     .attr("x", function(d) {
            //         return xScale(d[0]);
            //     })
            //     .attr("y", function(d) {
            //         return yScale(d[1]);
            //     })
            //     .attr("font-family", "sans-serif")
            //     .attr("font-size", "10px")
            //     .attr("fill","red")

            // svgScatter.append("g")
            //     .attr("class","axis")
            //     .attr("transform", "translate(0," + (h - padding) + ")")
            //     .call(xAxis)

            // //Create Y axis
            // svgScatter.append("g")
            //     .attr("class", "axis")
            //     .attr("transform", "translate(" + padding + ",0)")
            //     .call(yAxis);

        </script>
    </body>
</html>